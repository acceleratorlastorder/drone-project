function isJson(a){a="string"!=typeof a?JSON.stringify(a):a;try{a=JSON.parse(a)}catch(a){return!1}return"object"==typeof a&&null!==a}function sendTo(a,b,c,d,e){0==a?-1==c||void 0==c?console.log(theDate," no client connected yet"):user[c].client.send(b):-1==d||void 0==d?(console.log(theDate," no drone connected"),e.send(theDate+" drone not connected yet")):(console.log("drone index: ",d),user[d].drone.send(b))}let date=new Date,theDate=date.getDate()+"/"+date.getMonth()+"/"+date.getFullYear()+"-"+date.getHours()+":"+date.getMinutes()+": ",theDateWithMicroseconds=date.getDate()+"/"+date.getMonth()+"/"+date.getFullYear()+"-"+date.getHours()+":"+date.getMinutes()+":"+date.getSeconds()+"."+date.getMilliseconds()+":";const express=require("express"),http=require("http"),url=require("url"),WebSocket=require("ws"),app=express(),server=http.createServer(app);app.use(express.static("front")),app.use(function(a,b,c){console.log(theDate," visitor couldn't find the page with that path ",a.originalUrl," IP of the visitor: ",a.ip),b.sendFile("front/404.html",{root:__dirname})});const wss=new WebSocket.Server({server:server});var droneindex,dronesocket,clientindex,clientsocket,user=[];let connectedUser=0;wss.on("connection",function(b){url.parse(b.upgradeReq.url,!0);console.log(theDate," something is connected ws :",b.upgradeReq.headers["user-agent"]);var d=b.upgradeReq.headers["user-agent"],e=b.upgradeReq.headers["sec-websocket-key"];"NodeMCU"!=d?(console.log(theDate," Connection from: ",d),clientsocket={client:b},user.push(clientsocket),clientindex=user.indexOf(clientsocket),console.log(theDate," clientindex: ",clientindex)):(console.log(theDate," Connection from: ",d),dronesocket={drone:b},user.push(dronesocket),droneindex=user.indexOf(dronesocket),console.log(theDate," droneindex: ",droneindex)),connectedUser=user.length,b.send("hello we have at this moment "+connectedUser+" visitor"),b.on("message",function(c){date=new Date,theDateWithMicroseconds=date.getDate()+"/"+date.getMonth()+"/"+date.getFullYear()+"-"+date.getHours()+":"+date.getMinutes()+":"+date.getSeconds()+"."+date.getMilliseconds()+":",console.log(theDate," got message from: ",d),console.log(theDateWithMicroseconds," received: ",c),"NodeMCU"!=d?sendTo(1,c,clientindex,droneindex,b):sendTo(0,c,clientindex,droneindex,b)}),b.on("close",function(){e=b.upgradeReq.headers["sec-websocket-key"],console.log("connection with the client ",e," closed"),"NodeMCU"!=d?(user.splice(clientindex,1),console.log(theDate," client disconected !")):(sendTo(0,"drone disconnected",clientindex,droneindex,b),console.log(theDate," Drone disconnected!"),user.splice(droneindex,1))})}),server.listen(8080,function(){console.log(theDate," Listening on %d",server.address().port)}),console.log(theDate," server ",server.address());
